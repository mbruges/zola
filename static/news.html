<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link
            rel="stylesheet"
            href="https://maxbruges.com/experiments/1kb.css"
        />
        <title>News</title>
        <style>
            html {
                overflow-x: clip !important;
                font-family: monospace !important;
                background: transparent !important;

            }

            #topbox{
                text-align: center;
                margin-left: auto;
                margin-right: auto;
                z-index: 99;
            }

            #news-list {
                font-size:1ch;
                font-size: 0.8em;
                max-width: 30em;
                margin-left: auto;
                margin-right: auto;
                opacity: 0.7;
                text-align: justify;
                padding: 1rem;
                padding-bottom:1em;
                x-overflow:hidden;
            }

            #news-list p, #news-list em {
                font-family:sans-serif !important;
            }

            #news-list summary {
                -webkit-line-clamp: 2;
                overflow: hidden;
                text-overflow: ellipsis;
                padding: 0.7em;
            }

            details[open] > summary {
                font-weight: bold;
            }

        </style>
    </head>
    <body class="center">
        <h3 id="datetime" style="font-family: monospace;"></h3>
        <div id="news-list">
            <i style="text-align: center">Loading headlines...</i>
        </div>
        <script>
            function updateDateTime() {
                const now = new Date();
                const options = {
                    year: "numeric",
                    month: "long",
                    day: "numeric",
                };
                document.getElementById("datetime").innerText =
                    now.toLocaleString("en-GB", options);
            }

            updateDateTime();
        </script>
        <script>
            function getNews() {
                const feed = "https://api.mxb.fyi/news";
                const newsList = document.getElementById("news-list");
                const limit = 11;
                let newsData = localStorage.getItem("newsData");
                let newsLastUpdate = localStorage.getItem("newsLastUpdate");

                if (!newsData) {
                    localStorage.setItem("newsData", JSON.stringify([]));
                }
                const currentTime = Math.floor(Date.now() / 1000);
                //checking every hour
                if (!newsLastUpdate || currentTime - newsLastUpdate > 2600) {
                    fetch(feed)
                        .then((response) => response.json())
                        .then((data) => {
                            localStorage.setItem(
                                "newsData",
                                JSON.stringify(data),
                            );
                            localStorage.setItem("newsLastUpdate", currentTime);
                            updateNewsList(data);
                        })
                        .catch((error) =>
                            console.error("Error fetching the feed:", error),
                        );
                } else {
                    const cachedData = JSON.parse(newsData);
                    updateNewsList(cachedData);
                }

                function updateNewsList(data) {
                    let newsItems = "";
                    data.forEach((item, index) => {
                        if (index < limit) {
                            const title = item.title;
                            const link = item.link;
                            var description = item.description;
                            description = description.replace(
                                /<a[^>]*>(.*?)<\/a>/g,
                                "$1"
                            );
                            description = description.replace(
                                /<\/p>(?!.*<\/p>).*$/,
                                ` <a href='${link}' target="_blank">Read more -></a></p>`,
                            );
                            description = description.replace(
                                /<li>.*<\/li>/g,
                                "",
                            );

                            newsItems += `<details><summary>${title.length > 84 ? title.substring(0, 84) + "â€¦" : title}</summary><p>${description}</p></details>`;
                        }
                    });
                    newsList.innerHTML = newsItems;
                    newsList.querySelectorAll("details").forEach((details) => {
                        details.addEventListener("toggle", () => {
                            if (details.open) {
                                newsList.querySelectorAll("details").forEach((other) => {
                                    if (other !== details) {
                                        other.open = false;
                                    }
                                });
                            }
                        });
                    });
                }
            }
            getNews();
        </script>
    </body>
</html>
